name: ğŸ“Š Lighthouse (Programado / Manual)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 1" # Lunes 12:00 UTC

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: ğŸ“Š AuditorÃ­a Lighthouse (no bloqueante)
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Instalar dependencias
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "âš ï¸ package-lock.json no encontrado; usando npm install."
            npm install
          fi

      - name: ğŸ“Š Ejecutar Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        continue-on-error: true
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: false
          temporaryPublicStorage: true

      - name: ğŸ“¦ Subir artefactos de Lighthouse
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse_report
          path: |
            .lighthouseci/**
          if-no-files-found: warn
          retention-days: 14

      - name: ğŸ§© Generar badges Lighthouse (Node script)
        if: always()
        run: node scripts/generar-lighthouse-badges.js

      - name: ğŸ’¾ Commit de badges (solo schedule)
        if: always() && github.event_name == 'schedule'
        uses: EndBug/add-and-commit@v9
        with:
          add: "docs/badges/*.json"
          message: "chore(ci): actualizar badges de Lighthouse"
